#ORG Level Service Control Policies (SCPs)
SCPs provide centralized control over the allowed actions across AWS accounts, ensuring security, compliance, and effective resource management.
Service control policies (SCPs) are a type of organization policy that you can use to manage permissions in your organization.
SCPs offer central control over the maximum available permissions for all accounts in your organization.
SCPs help you to ensure your accounts stay within your organization’s access control guidelines. SCPs are available only in an 
organization that has all features enabled. SCPs aren't available if your organization has enabled only the consolidated billing features. 
SCPs alone are not sufficient in granting permissions to the accounts in your organization. No permissions are granted by an SCP. An SCP defines a
guardrail or sets limits, on the actions that the account's administrator can delegate to the IAM users and roles in the affected accounts. 
The administrator must still attach identitybased or resourcebased policies to IAM users or roles, or to the resources in your accounts to
grant permissions.  Effective is the logical intersection between what is allowed by the SCP and what is allowed by the IAM and resource based policies.
however, an SCP never grants permissions. Instead, SCPs are JSON policies that specify the maximum permissions for the affected accounts. 
    • SCPs affect only IAM users and roles that are managed by accounts that are part of the organization. SCPs don't affect resource-based policies directly. 
      They also don't affect users or roles from accounts outside the organization. For example, consider an Amazon S3 bucket that's owned by account A in an
      organization. The bucket policy (a resource-based policy) grants access to users from account B outside the organization. Account A has an SCP attached. 
      That SCP doesn't apply to those outside users in account B. The SCP applies only to users that are managed by account A in the organization.
    • An SCP restricts permissions for IAM users and roles in member accounts, including the member account's root user. Any account has only those 
      permissions permitted by every parent above it. If permission is blocked at any level above the account, either implicitly (by not being included in an 
      Allow policy statement) or explicitly (by being included in a Deny policy statement), a user or role in the affected account can't use that permission, 
      even if the account administrator attaches the AdministratorAccess IAM policy with */* permissions to the user.
    • SCPs affect only member accounts in the organization. They have no effect on users or roles in the management account.
    • Users and roles must still be granted permissions with appropriate IAM permission policies. A user without any IAM permission 
      policies has no access, even if the applicable SCPs allow all services and all actions.

  #Network Perimeter:
  Network perimeter SCPs define the network access controls for services, considering security zones, virtual private clouds (VPCs), and IP ranges.
  Limit access from external networks to specific ports and services.
 Define SCPs to prevent public access to sensitive resources.
 Enforce secure connectivity through VPN or Direct Connect for specific services.
 #example:
  Deny Public RDP Access: Deny RDP access (port 3389) to instances in a VPC from noncorporate IP addresses.
 Allow HTTPS Only: Allow only HTTPS (port 443) access to web servers from any location.
 '''json 
 {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyGlobalAccess",
            "Effect": "Deny",
            "Action": "*",
            "Resource": "*",
            "Condition": {
                "IpAddress": {
                    "aws:SourceIp": "0.0.0.0/0"
                }
            }
        }
    ]
}
 '''


 #Data Loss Prevention:
 Data loss prevention SCPs ensure sensitive data protection by controlling actions involving data transfer, encryption, and storage.
 Prevent public access to S3 buckets containing sensitive data.
 Enforce encryption for data at rest and in transit.
 Restrict the ability to share data across accounts.

 #Example:
 Deny External S3 Bucket Sharing: Deny sharing of S3 buckets with external accounts.
 Encrypt EBS Volumes: Ensure that EBS volumes are encrypted at rest.
 '''json
 {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyS3ExternalSharing",
            "Effect": "Deny",
            "Action": "s3:PutBucketAcl",
            "Resource": "*",
            "Condition": {
                "StringEqualsIfExists": {
                    "aws:PrincipalOrgID": "o-xxxxxxxxxx"
                }
            }
        }
    ]
}

 '''


 #Regional Control:
 
 Regional control SCPs manage access and resources within specific AWS regions, aligning with compliance and data residency requirements.

 Restrict resource creation to specific regions.
 Allow only approved regions for specific services.
 Implement regional redundancy and failover policies.

 #Example:
 
 Allow use1 and usw2 Only: Allow resource creation only in the useast1 and uswest2 regions.

 
 '''json 
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyCreateResourcesUSW2",
      "Effect": "Deny",
      "Action": "ec2:RunInstances",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "us-west-2"
        }
      }
    }
  ]
}

 '''

 
 Deny cac1 Usage: Deny resource creation in the Canada (Central) region.

 '''json
 {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCreateS3BucketsEUC1",
      "Effect": "Deny",
      "Action": "s3:CreateBucket",
      "Resource": "*",
      "Condition": {
        "StringNotEqualsIfExists": {
          "s3:LocationConstraint": "eu-central-1"
        }
      }
    }
  ]
}
'''


#Approved Service Management:
Approved service management SCPs ensure that only permitted services are used within each environment, 
avoiding unnecessary costs and potential security risks.
 Define service allow and deny lists per environment (e.g., Development, Production).
 Restrict access to services based on roles and responsibilities.


 #Example:
 a) Allow List for Development: Allow EC2, S3, and Lambda services for the Development environment.

 
 '''json
 {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowApprovedServicesDev",
      "Effect": "Deny",
      "Action": "ec2:*",
      "Resource": "*",
      "Condition": {
        "StringNotEqualsIfExists": {
          "aws:RequestedRegion": "us-east-1"
        }
      }
    }
  ]
}
'''


b) Deny the usage of specific services in the production environment.

'''json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyUnapprovedServicesProd",
      "Effect": "Deny",
      "Action": "s3:*",
      "Resource": "*",
      "Condition": {
        "StringEqualsIfExists": {
          "aws:RequestedRegion": "us-east-1"
        }
      }
    }
  ]
}
'''


#SCP Inheritance through OU Level:

SCP inheritance through Organizational Units (OUs) ensures that policies are applied hierarchically, streamlining management and maintaining consistency.
 Define SCPs at the organization level and inherit them to OUs.
 Tailor SCPs at the OU level to accommodate specific requirements.
 #Example
  OrganizationLevel Deny IAM Users: Deny IAM user creation at the organization level.
 OULevel Allow IAM Users: Allow IAM user creation within the "Development" OU.


 #EC2 Instance SCP and Maintenance procedures
 The EC2 Instance SCP defines the permissions and restrictions for managing EC2 instances at an organizational level.
 It ensures that only authorized users and roles can perform specific actions on EC2 instances, promoting the principle of least privilege.

 Least Privilege: SCPs should adhere to the principle of least privilege, allowing only the necessary actions and resources required for specific roles or groups.

Tag-Based Access: SCPs can be defined based on instance tags, enabling role-based access control for EC2 instances.

Region-Specific Restrictions: SCPs can restrict EC2 actions to specific AWS regions to enforce data residency or compliance requirements.

Instance Type Control: SCPs can limit the instance types that can be launched to control costs or enforce performance standards.

#Examples:
a) Allow Start/Stop/Reboot for Tagged Instances:
'''json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowStartStopReboot",
      "Effect": "Allow",
      "Action": [
        "ec2:StartInstances",
        "ec2:StopInstances",
        "ec2:RebootInstances"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "ec2:ResourceTag/Environment": "Production"
        }
      }
    }
  ]
}
'''

b) Deny Termination of Instances with Specific Tags:

'''json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyTermination",
      "Effect": "Deny",
      "Action": "ec2:TerminateInstances",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "ec2:ResourceTag/Restricted": "true"
        }
      }
    }
  ]
}
'''


## EC2 Instance Maintenance Procedures

Maintaining EC2 instances is crucial to ensure their reliability, security, and performance. Proper maintenance procedures should be followed to keep instances
up to date and well-managed. Below are some best practices for EC2 instance maintenance:

Regular Patching: Apply OS patches and security updates to instances on a regular basis to protect against known vulnerabilities.

Backup and Snapshot: Regularly back up critical data and create snapshots of instances to recover from potential failures or accidental data loss.

Instance Monitoring: Implement monitoring and alerting to track instance performance and detect anomalies or potential issues.

Auto Scaling and Load Balancing: Implement auto scaling and load balancing to ensure high availability and seamless resource allocation.

#Example:
The following policy restricts all users from launching EC2 instances without IMDSv2

'''json 
[
   {
      "Effect": "Deny",
      "Action":"ec2:RunInstances",
      "Resource":"arn:aws:ec2:::instance/",
      "Condition":{
         "StringNotEquals":{
            "ec2:MetadataHttpTokens":"required"
         }
      }
   },
   {
      "Effect":"Deny",
      "Action":"ec2:RunInstances",
      "Resource":"arn:aws:ec2:::instance/",
      "Condition":{
         "NumericGreaterThan":{
            "ec2:MetadataHttpPutResponseHopLimit":"3"
         }
      }
   },

   {
      "Effect":"Deny",
      "Action":"",
      "Resource":"",
      "Condition":{
         "NumericLessThan":{
            "ec2:RoleDelivery":"2.0"
         }
      }
   },
   {
      "Effect":"Deny",
      "Action":"ec2:ModifyInstanceMetadataOptions",
      "Resource":""
   }
]
'''



By implementing proper EC2 Instance Service Control Policies and following maintenance procedures, organizations can maintain a secure and well-managed AWS infrastructure,
ensuring high availability, reliability, and performance of EC2 instances.
Regular review and updates to SCPs and maintenance procedures will help adapt to changing business needs and security best practices.
